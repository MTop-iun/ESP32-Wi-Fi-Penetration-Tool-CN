# ESP32 Wi-Fi Penetration Tool


## 握手包捕获
WPA/WPA2-PSK(个人版)最常见的攻击方式是通过嗅探握手包并从中破解PSK(预共享密钥,即网络密码)。在WPA/WPA2握手过程中,双方交换参数,这些参数随后用于在双方计算相同的PTK(成对瞬时密钥)。下图展示了WPA/WPA2握手的示例:

![WPA握手序列图](../doc/drawio/wpa-handshake-seq.drawio.svg)

PTK用于一次已认证的会话,通信使用它进行加密(实际上不是PTK本身,而是从PTK派生的不同密钥,但如果你有PTK,你也可以推导出它们)。因此,任何能够计算PTK的人也可以解密站点(STA)和接入点(AP)之间的通信。除了这些公开传输的参数外,还有双方预先知道且从不传输的PMK(成对主密钥)。对于WPA/WPA2-PSK(个人版),PMK等于PSK;对于WPA/WPA2-企业版,PMK是从MSK/AAA密钥派生的(本文不涉及)。PSK本身可以进一步拆分。*密码短语*是我们需要破解的实际密码。下图展示了这一过程:

![WPA握手序列图](../doc/drawio/wpa-keys-hierarchy.drawio.svg)

*蓝色单元格是任何读取握手包的人都可以访问的公开值。橙色单元格是实际的密钥。*

#### PTK
- **PMK** - 成对主密钥(Pairwise Master Key)。双方预先知道此值且从不传输。
- **ANonce** - AP随机生成的值
- **SNonce** - STA随机生成的值
- **MAC AP + MAC STA** - AP和STA的Wi-Fi网络接口(NIC)的MAC地址

#### PMK/PSK
- **Passphrase** - 通常被称为网络密码、密码短语、Wi-Fi密码等。这是整个WPA/WPA2-PSK所依赖的唯一且真正的秘密部分。如果我们知道这个,我们就能计算PTK并解密流量,或者在没有MAC过滤等其他措施的情况下直接加入网络。
- **SSID** - 通常被称为Wi-Fi网络名称。这是你在可用网络列表中看到的人类可读(不一定)的字符串。
- **4096** - 这是密码短语被哈希的次数。这个值是设计上固定的。
- **256** - PSK的大小(以位为单位)。这个值也是设计上固定的。

WPA/WPA2握手使用EAPoL协议及其EAPoL-Key类型的数据包。这些数据包被封装在802.11数据帧中。请看以下帧结构分解:

![EAPOL-Key帧格式和层次结构](../doc/drawio/eapol-key-frame-format.drawio.svg)

简化的WPA/WPA2握手交换过程可以在本文开头的序列图中看到。

从上述描述中,我们可以看出实际上并不需要WPA/WPA2握手的全部四条消息。我们只需要捕获所有参数并有一个带有消息完整性代码(MIC)的完整EAPoL数据包。MIC是通过使用新计算的PTK加密整个EAPoL数据包(MIC字段初始化为零)计算得出的。MIC从第二条消息(STA的第一条消息)开始出现。它后来被附加到数据包中,这样对方可以验证消息是否被攻击者伪造。

![MIC计算过程](../doc/drawio/mic-calculation.drawio.svg)

这可以用于暴力破解攻击,通过猜测网络*密码短语*,计算PSK和PTK,然后加密捕获的EAPoL-Key数据包。如果结果与EAPoL-Key中原始存在的MIC匹配,我们就找到了正确的PTK和密码短语。

## 取消认证攻击
握手包捕获的一个缺点是,你必须实际等待目标AP发生某个握手过程。这使得握手包捕获变得不可预测。为了按需触发握手,这种攻击通常会先进行取消认证攻击,将已认证的STA从AP断开连接。结合常见无线设备供应商的做法,设备在未经用户意识的情况下与网络断开连接时会自动尝试重新连接。802.11标准定义了一个过程,AP或STA可以向其对方发送取消认证帧,以告知它们不愿继续之前已认证的会话。当这种情况发生时,想要继续通信的STA必须重新进行认证。

![取消认证帧格式](../doc/drawio/deauth-frame-format.drawio.svg)
## PMKID捕获

TBD